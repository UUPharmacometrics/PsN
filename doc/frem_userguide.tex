\input{inputs/format_header.tex}
\guidetitle{FREM userguide}{2016-02-08}


\begin{document}
\newcommand{\guidetoolname}{frem}

\maketitle

\section{Introduction}
The frem program builds a full random effects model (FREM) for covariate model building
 \cite{Karlsson}, \cite{Ivaturi}, \cite{Yun}.
Selection of covariates of interest is made without concern regarding their correlation.
Covariates are entered into the data set as observed variables, and their multivariate distribution are modeled
as random effects. A full covariance matrix between random effects for parameters and covariates is estimated
together with the other model components.

It can be difficult to get successful estimation of the full covariance matrix
if all FREM components are entered directly. The frem program builds the
full model in a sequence of steps,
using estimates from one step as initial estimates for the next.

Example call
\begin{verbatim}
frem run1.mod -covariates=SEX,DGRP,WGT
\end{verbatim}
%frem run1.mod -invariant=SEX,DGRP

\section{Output}

{\Large \texttt{More text here. Start with main default files}}

The main run directory will contain the frem\_vpc model and frem\_vpc dataset, if option -vpc was set.
The m1 subdirectory of the frem run directory will contain all other generated models, 
lst-files for the estimated models, and the frem dataset. 

\section{Input and options}
A model file is required on the command-line.

\subsection{Options}
\begin{optionlist}
%\optdefault{time\_varying}{list}
%A comma-separated list of time-varying covariates.
%Names used in \$INPUT. Optional if -invariant is given, not allowed if restarting an old run, otherwise required. 
%\nextopt
%\optdefault{occasion}{name}
%Default OCC. The name of the column that defines occasions. Name used in \$INPUT.
%Needed if -time\_varying is set, otherwise ignored.   
%\nextopt
%\optdefault{parameters\_bov}{list}
%A comma-separated list of model parameters that should have between-occasion variability. 
%Required if -time\_varying is set, otherwise not allowed. 
%\nextopt
%\optdefault{invariant}{list}
\optdefault{covariates}{list}
A comma-separated list of covariates, required. Must be the names used in \$INPUT, the data file headers are ignored.
%Optional if -time\_varying is given, not allowed if restarting an old run, otherwise required. 
\nextopt
\optdefault{log}{list}
Optional, default empty. A comma-separated list of covariates 
that should have the natural logarithm
of the input data set value as the observed value in the DV column of the frem dataset.
The -log list must be a subset of the -covariate list.
If any covariate listed with option -log is not in the list -covariates there will be an error message.
There must be no covariate listed with both log and -categorical.
\nextopt
\optdefault{ordered}{?} 
{\Large \texttt{??? Should there be special case for ordered categorical?}}
\optdefault{categorical}{list}
Optional, default empty.
A comma-separated list of categorical covariates. These will be automatically transformed from
one covariate with Y categories into Y-1 bivariate covariates, if Y>2. Missing values are not counted as a category.
The -categorical list must be a subset of the -covariate list.
If any covariate listed with option -categorical is not in the list -covariates there will be an error message.
There must be no covariate listed with both -categorical and -log.
\nextopt
%\optdefault{skip\_etas}{non-negative integer}
%The number of leading input model ETAs to \emph{not} include when estimating covariances
%between parameter and covariate ETAs. The default is 0, which means all 
%input model ETAs will be correlated to covariates.
%The non-included ETAs, if any, must be the first 1 to 'skip\_etas' ETAs in the model.
%If the input model has BOV, the BOV ETAs must be skipped using this option, so if the model has BOV the ETAs must
%be the the first 1 to 'skip\_etas' ETAs. This option is not allowed in combination with skip\_omegas.
%\nextopt
\optdefault{skip\_omegas}{comma-separated list of record numbers}
Default is all BOV omega records, if any.
An \$OMEGA is classified as a BOV record either if it is SAME, or if the next \$OMEGA is SAME. 
If -skip\_omegas is set,
then these records will be excluded from the full parameter-covariate covariance block.
The omega records will be reordered and ETAs renumbered so that all non-skipped
omegas/ETAs are last in the model, so that the covariate omega and non-skipped parameter omega
can be combined into a single large block.
\nextopt
\optname{estimate\_cholesky\_final\_model}
Default not set.
If set then script will estimate
the final cholesky parameterized frem model, otherwise the model will be
created but not estimated.
\nextopt
\optname{estimate\_regular\_final\_model}
Default set.
If set then script will estimate
the final regular parameterization frem model, otherwise the model will be
created but not estimated.
\nextopt
\optname{rescale}
Default not used. Rescale ETAs in Model 2 to SD close to 1.
Note: If this option is set, the construction of a proposal density for sir,
in case the covariance step of Model 4 fails, will not be done correctly.
% in order to facilitate estimation.
\nextopt
\optname{run\_sir}
Default set. Disable with -no-run\_sir. If covariance step of Model 4 fails, run sir
to obtain standard errors of parameters.
\nextopt
\optdefault{rse}{number}
Default 30 \%.
If the covariance step of both Model 4 and either/both of Model 1 and Model 2 fails, then
this is the guess of relative standard error that will be used for parameters for which there is no other
information that can be used to guess the variance needed for 
a proposal density for a sir run with Model 4.
\nextopt
\optname{vpc}
{\Large \texttt{Later}}
Default not set. If set then script will create a frem model that can be run with the vpc script (in a separate call to the vpc pscript).  
\nextopt
\optname{check}
Default not set. Run evaluation with frem records ignored after frem data set generation, to check ofv is the same.
\nextopt
\optdefault{rplots}{level}
{\Large \texttt{Later}}

%\optdefault{dv}{name}
%Default is DV. The name of the dependent variable. This must be the name used in \$INPUT,
%the data file header is ignored. 
%\nextopt
%\optdefault{estimate}{number}
%Optional, default 3. The number (0, 1, 2 or 3) of the last model to estimate in the frem sequence. All models with a higher number will still be created, but not estimated. When restarting in an existing frem run directory, estimation of models that have an existing lst-file will be skipped even if the -estimate option is set to a higher number.
%\nextopt
\end{optionlist}
\subsection{Some important common PsN options}
For a complete list see common\_options.pdf, 
or psn\_options -h on the commandline.
\input{inputs/basic_options.tex}


\subsection{Restrictions on the input model}
\begin{itemize}
%	\item Time-varying covariates must only vary between occasions, not within occasions. 
	\item There must be no parameter called FREMTYPE in \$INPUT/\$PK/\$PRED/\$ERROR.
	\item Categorical covariates must be bivariate, unless listed with option -categorical.
    \item All input model ETAs that are not to have covariance with covariate ETAs estimated must
    belong to a skipped omega record (either explicitly set with option -skip\_omegas or
    automatically skipped since it is a BOV ETA).
    \item The input model code must not include covariates that are listed with 
    -covariates.
%    \item Only if option -vpc is set: All model parameters (for example CL, V, KA) with ETA number > skip\_etas must be defined using \\
 %   TV$<$par$>$= expression possibly based on THETA, and\\
  %  $<$par$>$= expression using TV$<$par$>$ and BSV ETA
%    \item Parameters listed with option -parameters\_bov must be defined in the mode following pattern:
%    \begin{itemize}
%    \item  {\bf BOV ETAs already in input model:}
%    The BOV ETAs must have ETA numbers that are all greater than the last BSV ETA.
%    The corresponding parameter must be defined using \\
%    $<$par$>$= expression using TV$<$par$>$ and BOV ETA
%    \item {\bf BOV not already input model:}
%    For each parameter listed with option -parameters\_bov, 
%    the line defining $<$par$>$ 
%    must include a BSV-expression. Even if there is no 
%    BSV for a parameter listed with option -parameters\_bov, 
%    i.e. the value is equal to the typical value, the user must still 
%    include an expression with 0 in the place of the BSV eta, using the desired form
%    (additive, proportional, exponential,..). 
%    This is necessary to enable PsN to automatically add the BOV code. The 0 must be enclosed in parentheses,
%    otherwise the frem program will not recognize it. Example with placeholder for additive inclusion of BOV:\\
%    $<$par$>$=TV$<$par$>$ + (0) \\
%    Example with placeholder for exponential inclusion of BOV:\\
%    $<$par$>$=TV$<$par$>$*EXP(0)
%    \end{itemize}
%	\item TODO: If -vpc is set: Form of TV$<$par$>$ or THETA directly
\end{itemize}

\section{Workflow}
\begin{enumerate}
\item Input checks, for example that DV is found in \$INPUT.
%Skip ETAs with number <= skip\_etas. For all remaining BOV ETAs, if any,
%check which parameter they are on by searching for expressions of the form\\
%$<$par$>$= expression using TV$<$par$>$ and BOV ETA.
%If the parameter found is not listed with option -parameters\_bov there will be an error message.
%\item Check that there are no non-BOV ETAs after the first non-skipped BOV ETA, otherwise give error message.

%\item Check that the first (non-skipped) parameter ETA is the first in a new \$OMEGA record, otherwise give error message.
\item Unless input model is already run,
run a copy of the input model (Model 1) to get estimates.
%\item Count the number of parameter \$OMEGA blocks, N\_parameter\_blocks,
%that are needed in the frem model:
%Initiate N\_parameter\_blocks = 0. Skip all \$OMEGA for ETA <= skip\_etas.
%Then add 1 for each block \$OMEGA and add N for each diagonal \$OMEGA of size N.
%\item Create frem dataset according to section FREM dataset below, include covariate observations 'N\_parameter\_blocks' time(s).
%\emph{Alternative:} 
\item Create frem dataset according to section FREM dataset below, include covariate observations 1 time.

%\item Create Model 1, model without covariates, with full \$OMEGA block for parameter BSV ETAs but without
%and parameter BOV ETAs (pre-existing BOV ETAs removed), according to section below. Original data set.
%\item Run Model 1.
\item Create Model 2, model with covariates but without
estimation of covariances between parameter and covariate ETAs,
according to section below. FREM dataset.
THETA and OMEGA and SIGMA for PK parameters are FIXED in this model.
%Include \$COV.
\item Estimate Model 2.
\item Create Model 3.
%where there are N\_parameter\_blocks full \$OMEGA blocks with all covariances between parameter and covariate ETAs,
%according to section below.
Model 3 is a copy of Model 2, but all non-skipped Model 1 omega plus covariate omega are combined
into single large block. For covariances between parameter omegas that did
not have covariance in Model 1, set very very small init $10^{-7}$.
Initial values for covariances between parameter-covariate ETAs are computed from
phi-file from estimation of Model 2. Finally, ensure that omega block is positive definite.
Set MAXEVAL=0 and remove \$COV.
\item Evaluate Model 3 to get more accurate phi-file ETAs.
\item Recompute correlations
between parameter and covariate ETAs based on phi-file from Model 3 evaluation,
use these to create Model 4.

Model 4 is a copy of model 3, but update parameter-covariate covariances from phi-file from evaluation of Model 3
(a rectangular part of \$OMEGA block).
Leave all parameter-parameter and covariate-covariate covariances as is, but
finally check that updated omega block is positive definite.
Set estimation record back to what it was in Model 1.
Set covariance record back to what it was in Model 2.
Unfix everything that was not fix in Model 1.
Model 4 is the (unestimated) regular parameterization FREM model.
\item
Create Model 5 by
Cholesky reparameterizing the \$OMEGA block
for parameter-covariate ETAs in Model 4.
Set to 0 FIX the parameter-parameter correlations that are 0 in Model 1 (separate blocks in Model 1).
FIX everything in model except parameter-covariate correlation THETAs.
\item Estimate Model 5, include \$COV step.
\item Create Model 6 
by copying Model 5 and updating initial estimates from
estimation of Model 5, and then un-FIX everything except parameters that
were FIX in input model (Model 1) and correlations that are exactly 0.
Model 6 is the (unestimated) Cholesky parameterization FREM model.
\item Only if option -estimate\_cholesky\_final\_model is set:
Estimate Model 6, include \$COV step.
\item Only if option -estimate\_regular\_final\_model is set:
Estimate Model 4 (FREM regular model), include \$COV step.
Estimation is done in parallel with Model 6, if estimation of Model 6 was requested.
%\item If option -vpc is set, the script will also 
%run the vpc1 model using estimates from FREM model as initial estimates,
%and finally process output to generate a frem vpc model.
\item Only if covariance step of Model 4 was not successful:
Use sir to estimate the uncertainty of Model 4 parameters, see section Model 4 sir.
\end{enumerate}

\section{Model 4 sir}

Create a proposal density to use with -covmat\_input option to sir:
\begin{enumerate}
\item Create an empty covariance matrix with dimensions for Model 4 estimated parameters.
This matrix will hold the joined proposal covariance matrix.
\item If covariance step of Model 1 was run and was successful: Copy all available
elements to joined matrix. Reorder them if Model 1 was reordered because of skipped omegas.
\item If covariance step of Model 2 was successful: Copy all available
elements to joined matrix
\item For each diagonal element of joined matrix that is still not filled and is
the variance of a Model 4 OMEGA element: If a ``perfect individual'' count $\hat{N}_{x,y}$ can
be computed using formula below, then set variance to
\[
var\left(OMEGA(x,y)\right)\approx \frac{1}{\hat{N}_{x,y}}
\left( OMEGA(x,y)^2 + OMEGA(x,x)\cdot OMEGA(y,y) \right)
\]
where OMEGA estimates are from Model 4.
\item For remaining diagonal elements of joined matrix that could not yet be filled,
compute a variance guess based on input option -rse and parameter estimate from Model 4.
\end{enumerate}

Perfect individual counts:
\[
\hat{N}_{x}=1+2\left(\frac{OMEGA(x,x)}{se\left(OMEGA(x,x)\right)}\right)^2
\]
where OMEGA(x,x) estimates and se are from covariance step of Model 1 or Model 2, wherever the
OMEGA was estimated.

\[
\hat{N}_{x,y} = \sqrt{\hat{N}_{x}\cdot \hat{N}_{y}}
\] if available standard errors allow both $\hat{N}_{y}$ and $\hat{N}_{x}$ to be computed.
If only $\hat{N}_{x}$ or $\hat{N}_{y}$ available, used that. If neither available then
cannot use formula, use rse fallback instead.

Run sir with -covmat\_input.

\section{Model 1}
The input model, input dataset.

\section{FREM Dataset}
Create a new data set.
\begin{enumerate} 
	\item In input dataset: Find EVID and/or MDV columns. If neither found then MDV will be added. Find DV column.
    For each covariate  determine a unique %(set of N\_parameter\_blocks)
    FREMTYPE value %(s)
    > 0.
    FREMTYPE=0 is reserved for original observations.
    \item Find each column listed with -categorical and count the number of categories Y. Missing values are not counted as
    a category. 
    \item Create a filter model. This is either a dummy NONMEM model or, if MDV has to be added,
    the original model with MAXEVAL=0 METHOD=ZERO and without \$COV.
	\item Run the filter model where FREMTYPE=0 to filter the original data on any IGNORE/ACCEPT and to get a new data file
    from \$TABLE where the column headers are the same as in \$INPUT but a FREMTYPE column is added with only zeros as values.
    Also add MDV if not EVID or MDV in data set. In the dummy model columns that are DROPped or SKIPped are replaced with an undropped column so that the filtered data set has the same number of columns as the original data set.
    \item  In new data file, append columns for Y-1 new bivariate covariate variables for each
          categorical covariate where number of categories Y>2. In subsequent analysis steps, replace old covariate with
          Y-1 new variables.
\item Then loop over each individual: 
\begin{enumerate}
	\item Copy first observation line for individual. i.e. first line where MDV/EVID ==0. 
Loop over each covariate: Add one % N\_parameter\_blocks
new line %(s)
just before first observation line for individual. 
On each copied line, set value in DV column to covariate value, or ln(value) if this covariate is listed with option -log,
and FREMTYPE to a unique type-value for this covariate. % and parameter block. 
If MDV column present then MDV=0 if have covariate value, MDV=1 if value is missing. 
Else if EVID present then EVID=0 if non-missing covariate value, otherwise EVID=2. 
Store non-missing covariate values in array, one array per covariate, to be able to compute medians and 
variance-covariance matrix later to be used as initial estimates in \$THETA and \$OMEGA. 
%	\item Loop over each occasion (if OCC defined). 
%Copy first line observation line for this occasion. 
%Inner loop over each time-varying covariate: 
%\begin{enumerate}
%	\item Add new line as first data set line for this occasion. 
%    \item Set DV value to covariate value for this occasion. 
%    \item Set FREMTYPE to type-value for this covariate. 
%    \item If MDV present then MDV=0 if have covariate value, otherwise MDV=1. 
%    If EVID present then EVID=0 if have covariate value, otherwise EVID=2. 
%    \item Store non-missing time-varying covariate values (to compute median over occasions for this individual, 
%    median is one scalar per covariate.) 
%    \item[] (end inner loop over time-varying cov)
%\end{enumerate}
%\item[] (end loop over occasions)
%\item Compute median of time-varying cov over occasions for this individual, median is one scalar per covariate.
%\item Then store non-missing medians in array, one array per time-varying covariate, (to compute 
%median of medians later for \$THETA, and variance-covariance matrix  to be used in \$OMEGA).
\item[] (end loop over individuals)
\end{enumerate}

	\item Compute medians of %invariant and time-varying
    covariates. Warn if any median has absolute value less than $10^{-2}$ since additive error will be inappropriate for that covariate.
    Also compute variance-covariance matrix %of invariant covariates, and of medians (over occasions) for time-varying. Two separate variance-covariance matrices.
    If missing values then just skip.
\end{enumerate}

This dataset is used for Model 2 and on.

\section{Data check model, FREM Dataset}
\subsection{Initiation}
Copy Model 1.

\subsection{DATA changes}
Set \$DATA to FREM dataset. Skip old IGNORE/ACCEPT. Set IGNORE=@ IGNORE=(FREMTYPE.GT.0)

\subsection{INPUT changes}
Append extra items to \$INPUT: MDV(possibly) and FREMTYPE.

For safety check, done if option -check is set: Estimate Data check model. OFV should be identical to Model 1 OFV.


\section{Model 2}

%For BOV the script defines a variable BOV$<$par$>$ for each parameter, and then BOV$<$par$>$ is set equal to different ETAs depending on the occasion. Same for BOV$<$covariate$>$. See details below. 
%This method is safer to implement than having switch variables for occasions that are 1 or 0 depending on the occasion, and then use a long sum of products between switch variables and ETAs. 

%For BOV\_par block, use \$OMEGA estimates from Model 0 if it had any BOV ETAs, and use
%phi-file to compute initial values for covariances.

\subsection{SETUP}
%Count number n\_theta of already present THETAS in Model 0. Count number bsv\_parameters, which is
%equal to already present ETAs 
%(dimensionality of total \$OMEGAs in Model 0) minus (start\_eta-1). 
Count number of n\_eps already present (dimension of \$SIGMA in Model 1), set epsnum=n\_eps+1.
Build Model 2 based on copy of Model 1, after updating initial estimates with final estimates
from estimation of Model 1.

\subsection{DATA changes}
Set \$DATA to FREM dataset. Skip old IGNORE/ACCEPT. Set IGNORE=@.

\subsection{INPUT changes}
Append extra items to \$INPUT: MDV(sometimes) and FREMTYPE.

\subsection{OMEGA changes}
%For the set of non-skipped parameter ETAs, change any diagonal \$OMEGA of size N>1
%to N \$OMEGA of size 1.
Automatically add BOV \$OMEGAs to skip\_omegas.
Reorder \$OMEGA based on -skip\_omegas, so that all skipped come first, and renumber ETAs.
All non-skipped diagonal \$OMEGA of size $N>1$
are replaced with $N$ \$OMEGA of size 1.
Auto-set skip\_etas, error message if no ETAs remain.

FIX all \$OMEGAs from Model 1.

%After each of the 'N\_parameter\_blocks' \$OMEGA for non-skipped ETAs, insert  
Insert
a full BLOCK(N\_covariates) where initials is variance-covariance matrix of
covariates computed during creation of dataset.
%Renumber existing parameter BSV ETA:s accordingly in \$PK/\$PRED.

\subsection{SIGMA changes}
FIX all \$SIGMA from Model 1.
Add\\
\$SIGMA 0.000001 FIX; EPSCOV
%only one sigma even if many N\_parameter\_blocks

\subsection{THETA changes}
FIX all \$THETAs from Model 1.
Loop over all covariates, j=1...N\_covariates, %with inner loop over k=1...N\_parameter\_blocks,
add lines\\
%\$THETA init\_j ; TVcov\_j\_k\\
\$THETA init\_j ; TVcov\_j\\
where init\_j is median of covariate j computed during creation of new data set, cov\_j is the name of covariate
j. %and k is the order number of the parameter block.
If median is exactly zero set
init to a very small positive value. 
Store the mapping between the theta label and the theta number.%TVcovname – THETA(n\_theta+j). 
%TODO: Possibly set boundaries to max and min for covariate, in that case need to find that during generation of dataset 2.
\subsection{PK/PRED changes at beginning}
In \$PK or \$PRED, whichever is present:
At the very beginning (unless have FREM-ANCHOR similar to scm- anchor) the following code: \\
Loop over covariates j=1...N\_covariates, %parameter blocks k=1...N\_parameter\_blocks,
add lines

%\noindent BSV\_$<$cov\_j$>$\_k = ETA(orig\_etas+(j-1)*N\_parameter\_blocks +k)\\
%\noindent TV\_$<$cov\_j$>$\_k = THETA(orig\_thetas+(j-1)*N\_parameter\_blocks +k)
\noindent BSV\_$<$cov\_j$>$ = ETA(orig\_etas+j)\\
\noindent TV\_$<$cov\_j$>$ = THETA(orig\_thetas+j)

%\noindent Loop over parameters\_bov, initialize BOV PK (provided there are any time-varying cov)
%\noindent BOV$<$parameter$>$=0
%\noindent Loop over occasions k=1...N\_occ , one IF block per occasion
%\noindent IF (OCC .EQ. k) THEN\\
%(inner loop over parameters j=1$\ldots$bov\_parameters)\\
%BOV$<$parameter$>$ = ETA(offset+N\_invariant+(k-1)*bov\_parameters+j)\\
%END IF
%\noindent Loop over time-varying covariates, initialize BOV tcov
%BOV$<$covariate$>$=0
%\noindent Loop over occasions k=1...N\_occ , one IF block per occasion
%IF (OCC .EQ. k) THEN
%\noindent (inner loop over time-varying covariates j=1...N\_time-var)
%\noindent BOV<covariate> = ETA(offset+N\_invariant+N\_occ*Nparams+(k-1)*N\_time-var+j)\\
%END IF
%\subsection{PK or PRED changes at beginning, B}
%In \$PK or \$PRED (continuing):
%Loop over parameters\_bov (provided there are any time-varying cov)
%Locate line with 
%$<$par$>$ = TV$<$par$>$ (expression containing ETA or (0) as BOV placeholder)
%Add BOV$<$parameter$>$ at appropriate place in $<$par$>$=TV$<$par$>$... expression.

\subsection{PRED or ERROR changes at end}
In \$PRED or \$ERROR, whichever is present:
At the very end\\
Loop over covariates, j=1...N\_covariates %, parameter blocks k=1...N\_parameter\_blocks
%\begin{verbatim}
%Y_<cov_j>_k = TV_<cov_j>_k + BSV_<cov_j>_k
%\end{verbatim}
\begin{verbatim}
Y_<cov_j> = TV_<cov_j> + BSV_<cov_j>
\end{verbatim}


%Loop over time-varying covariates, j=(N\_invariant+1)...(N\_invariant+N\_time-var), use THETA-covname mapping, add lines
%\begin{verbatim}
%Y<j> = THETA(cov) + BOV<cov>
%\end{verbatim}
Loop over covariates j=1...N\_covariates %, parameter blocks k=1...N\_parameter\_blocks
%\begin{verbatim}
%IF (FREMTYPE .EQ.((j-1)*N_parameter_blocks +k)) THEN
%Y=Y_<cov_j>_k+EPS(epsnum)
%IPRED=Y_<cov_j>_k
%END IF
%\end{verbatim}
\begin{verbatim}
IF (FREMTYPE .EQ. j) THEN
Y=Y_<cov_j>+EPS(epsnum)
IPRED=Y_<cov_j
END IF
\end{verbatim}

%\emph{Alternative:} Do not loop over N \_parameter\_blocks, insert code only once for each covariate

(do not define a case for FREMTYPE=0, original obs. Leave original code as it is for that)

\subsection{\$COV changes}
If there was no \$COV record in Model 1, add
\begin{verbatim}
$COVARIANCE PRINT=R UNCONDITIONAL
\end{verbatim}

\subsection{Rescaling of ETAs}
Only if option -rescale is set:
For each non-skipped \$OMEGA and new \$OMEGA for covariates:
\begin{enumerate}
\item Find the ETA numbers for this \$OMEGA.
\item Compute the initial values for the standard deviations (SD) as the square root of the diagonal
element(s) of this \$OMEGA.
\item Add a new THETA FIX for each SD. Set label ASD\_(label for diagonal omega)
\item In \$PK or \$PRED, whichever is present:
At the very beginning (unless have FREM-ANCHOR similar to scm- anchor) add the following code: \\
\begin{verbatim}
ASD_ETA_N = THETA(k)
\end{verbatim}
where ASD stands for approximate SD, N is the ETA number, and k is the THETA number.
\item Divide \$OMEGA row and column initial values with for this ETA with the SD
\item In all code records (PK, PRED, ERROR...) replace all instances of ETA(N) with (ETA(N)*ASD\_ETA\_N)
\end{enumerate}

\section{Models 3-6}

Described above in workflow

%This models is a copy of Model 2, but each pair of input model BSV and covariate blocks is combined
%into one large full block. Initial values for the new covariances are computed from
%phi-file from estimation of Model 2.
%Set MAXEVAL=0.



\section{Practical considerations}
It can be expected that not all models in the frem sequence minimize successfully, and that this in turns 
causes problems or errors in subsequent steps. 
When this happens, the user can copy the problematic model and data from the m1 subdirectory and experiment with
different initial estimates to get the minimization to succeed. Then the user should manually remove old output files for the
failed run from the m1 subdirectory and replace them with output from the manipulated successful run, using the same 
output file names. It is important to keep output files for all the successful runs preceeding the failed run, 
otherwise PsN would rerun all models that do not have output files
in m1. Output files from all steps after the manipulated step should also be removed.
Finally the frem run should be restarted setting option -directory to the existing directory, and skipping 
options that are not allowed when restarting a run (see information in list of options). The script
will then use the existing output files as a starting point when continuing the analysis.

%It can happen that final estimate OMEGA blocks in Model 3 are not positive definite due to rounding errors. Then the scripts
%will halt with an error messages. In that case the user should remove all vpc\_model\_1 output files from
%the m1 directory, open model\_3.ext and carefully add a small value to the diagonal elements of the problematic omega block,
%save the edited model\_3.ext in m1, and restart frem. The program will then read the omega block from model\_3.ext
%without running model 3 and then use that block instead.

\section{Creating FREM vpc model}
Needs to be revised.
Done if option -vpc is given to FREM script. This part of the recipe describes modifications needed to FREM model and data set before running vpc. Definitions of model types (Model 2 and FREM Model) and names of \$OMEGA blocks are as in description above. 

\subsection{Step 1: Obtain typical parameter values conditional on covariate info}
Create frem\_vpc1.mod

\begin{enumerate}
	\item Take FREM Model. Update inits from estimation, if available. Afterwards FIX \$THETA and \$OMEGA. Unfix all \$SIGMA.
	\item Set IGNORE=@ IGNORE=(FREMTYPE.GT.0)
	\item Remove \$COV.
	\item In \$PK or \$PRED, whichever is present:
Figure out which parameters that have BSV %and/or BOV eta(s)
on them.
%BOV ETAs may not have been present in Model 0, but added in Model 2. 
%Parameters may have BOV ETA without BSV eta, and vice versa. 
%First take all parameters listed with option -parameters\_bov, since they have had BOV ETAs added. Then find additional
Find parameters
that have BSV ETA %already
in model 1.
To do this: Find all code lines starting with TV$<$par$>=$ in Model 1. Then find the lines starting with the corresponding $<$par$>=$ and
check if there is any ETA in the right hand side expression. If yes, then store the parameter name $<$par$>$.  
% If not find THETA number then raise error.
	\item Add \$TABLE with list of all undropped \$INPUT variables plus names of parameters that have BSV eta  + ONEHEADER NOAPPEND NOPRINT FILE=frem\_vpc.dta
	\item Store sequence of headers in \$TAB to be used in \$INPUT in model frem\_vpc2.mod, but in this list prepend parameter names with CTV to separate from other params.
	\item Run model with NM.
\end{enumerate}

\subsection{Step 3:  Calculate parameter OMEGA conditional on covariate OMEGA}
Create frem\_vpc2.mod
\begin{enumerate}
	\item Base this model on Model 1. %1.
    \item Make the same SIGMA changes as in Model 2. 
%    \item Make similar OMEGA changes as in Model 2, but no not add any BSV\_cov block or BOV\_cov\_occN blocks.
    \item Do not add any THETAs.
    \item Copy THETA, SIGMA estimates and 1-skip\_etas leading OMEGA estimates from vpc1.
	\item DATA is frem\_vpc.dta
	\item Set IGNORE=@ 
 %   \item Make the ``PK or PRED changes at beginning, A'' as in Model 2 except skip all lines involving BSV<cov> or
 %   BOV<cov>, and renumber remaining ETAs accordingly.
 %   \item Make the same ``PK or PRED changes at beginning, B'' as in Model 2.
	\item Set \$INPUT to sequence of headers from step 1 (contents of table file frem\_vpc.dta but prepend CTV for params)
	\item Use parameter list from Step 1 to set TV$<$par$>$ = CTV$<$par$>$ for 
parameters that have BSV ETA %and/or BOV ETA
on them.
	\item Read final estimated BSV\_all omega blocks from lst-file and compute conditional omega blocks, 
    see Appendix “Compute conditional omega block” below. In \$OMEGA replace BSV\_par blocks with 
    conditional omega blocks from computation.
%	\item Read final estimated BOV\_full\_occ1 omega block from lst-file from Step 1 compute conditional omega block 
%    in the same way as for BSV. In \$OMEGA replace BOV\_par\_occ1 with conditional block.
    \item Remove any \$COV
\end{enumerate}

\subsection{Step 4: Prepare to run  vpc}
Now a regular vpc can be run on frem\_vpc2.mod found in the frem run directory.


\section{Appendix: Compute conditional omega block}
To calculate the conditional covariance matrix, 
one inverts the overall covariance matrix, 
drops the rows and columns corresponding to the variables being conditioned upon, and then inverts back to get the conditional covariance matrix.
% Should use generalized inverse, but we skip that for now
\begin{math}
\Omega^{-1}\Omega = I
\end{math}

To avoid inverting a full matrix, which is numerically wasteful in terms of time and precision, we instead want to perform a sequence of numerically more stable steps.
We have a symmetric $n\times n$ variance-covariance matrix $\Omega$, and want to obtain the leading upper $k\times k$ submatrix $\Omega^{-1}_{11}$
of $\Omega^{-1}$, where
\[
\Omega^{-1} = \left( \begin{array}{cc}
\Omega^{-1}_{11} & \Omega^{-1}_{12}\\
\Omega^{-1}_{21} & \Omega^{-1}_{22} 
\end{array} \right)
\] with sizes \[
\left(
\begin{array}{cc}
k\times k & k\times (n-k)\\
(n-k)\times k & (n-k)\times (n-k) 
\end{array}
\right)
\] 
\begin{enumerate}
\item Make a Cholesky decomposition of omega, $\Omega=GG^T$
\item Obtain the inverse of $\Omega$ by solving the triangular system $G^{T}G^{-T}=I$ for just the $k$ first cols and using $\Omega^{-1}=G^{-T}G^{-1}$
\item We want the upper $k\times k$ submatrix of $\Omega^{-1}=G^{-T}G^{-1}$.
\end{enumerate}
%Ok to run on block from BOV omega?

\begin{thebibliography}{99}
\bibitem{Karlsson} M. O. Karlsson,
{\em A full model approach based on the covariance matrix of parameters and covariates},
PAGE 21 (2012) Abstr 2455 \mbox{www.page-meeting.org/?abstract=2455} 
\bibitem{Ivaturi}
V. Ivaturi, R. Keizer and M. O. Karlsson,
{\em A Full Random Effects Model for Characterising Covariate Relations},
WCOP (2012) Abstract W-152.
\bibitem{Yun}
H. Yun, R. Niebecker, E. M. Svensson and M. O. Karlsson,       
{\em Evaluation of FREM and FFEM including use of model linearization},
PAGE 22 (2013) Abstr 2900 \mbox{www.page-meeting.org/?abstract=2900}    
\end{thebibliography}     
                          


\end{document} 

\section{Model 1}
This filling in of \$OMEGA is only done if there are invariant covariates listed with the -invariate option.

Copy the input model and change \$OMEGA for skip\_etas+1 to last\_bsv\_eta
from whatever form in Model 0 to a single large BLOCK. If any BOV ETA included in input model,
then replace those ETAs in model code with zeros, and remove corresponding \$OMEGA.
Update initial estimates with final estimates from Model 0.
Initial off-diagonal \$OMEGA elements that are new to Model 1 are set using
correlations computed from the ETA columns in the phi-file of Model 0, and estimated variances.
The large \$OMEGA block of Model 1 is called the BSV\_par block.

Then, if have time-varying covariates:
\begin{itemize}
\item BOV\_par\_occ1: Add one full BLOCK(bov\_parameters) where initials is: diagonal 0.01 and off-diagonals small enough to make
block positive definite.
At each line, possibly add comment with BOV$<$parameter$>$ to be used as label for ETA in PsN
%could in filtering print individual parameters and compute variance??? Use .cov from previous step??? probably not
\item BOV\_par\_occ2-end: Then, for each occasion that is not the first occasion add BLOCK SAME.
\item BOV\_cov\_occ1: Add one full BLOCK(N\_time-var) where initials is variance-covariance matrix of time-varying covariates computed during creation of dataset
At each line, possibly add comment with covariate name to be used as label for ETA in PsN
\item BOV\_cov\_occ2-end: Then, for each occasion that is not the first occasion add BLOCK SAME.
\end{itemize}

\section{Model 2-only time-varying}
Use FREM dataset but in \$DATA set IGNORE for all FREMTYPE for invariant covariates. Build model based on Model 0 (no filling in of BSV block). Add code and parameters according to Model 2 instructions above but set the number of invariant covariates N\_invariant to 0

\section{Model 2-only time-invariant}
Use FREM dataset but in \$DATA set IGNORE for all FREMTYPE for time-varying covariates. Build model based on Model 0 (no filling in of BSV block). Add code and parameters according to Model 2 instructions above but set the number of time-varying covariates N\_invariant to 0.

\section{Model 3}
\subsection{SETUP}
Same as for Model 2 (build on Model 0 or 1)

\subsection{DATA changes}
Same as Model 2.
\subsection{INPUT changes}
Same as Model 2.

\subsection{OMEGA changes}
BSV\_all: One full BLOCK(bsv\_parameters+N\_invariant).
%Initials: EITHER from eta estimates from Model 2 (from .phi-file), compute variance-covariance matrix. OR 
Same initials as in Model 2 plus small values to fill in full block. When Model 2 is estimated
the final estimates can be used to set initials in FREM Model.

Then, provided have time-varying covariates:
BOV\_all\_occ1: Add one full BLOCK(bov\_parameters+N\_time-var) where bov\_parameters is number of parameters set with -parameters\_bov option.
%Initials: EITHER from eta estimates from Model 2, compute variance-covariance matrix (.phi-file, must rearrange ETAs to new order in Model 3). OR 
Same initials as in Model 2 plus small values to fill in full BLOCK.
BOV\_all\_occ2-end: Then, for each occasion that is not the first occasion add \$OMEGA BLOCK SAME.

\subsection{SIGMA changes}
Same as Model 2.

\subsection{THETA changes}
Same as Model 2.

\subsection{PK or PRED changes at beginning A}
Very similar to Model 2, but different arrangement of loops so that ETA numbering is different.
In $PK or $PRED, whichever is present:
At the very beginning (unless have FREM-ANCHOR analogue to scm- anchor) the following code: 
Loop over invariant covariates j=1...N\_inv, add lines
\begin{verbatim}
BSV<cov> = ETA(offset+j)
\end{verbatim}
Loop over parameters\_bov, initialize BOV PK (provided there are any time-varying cov)
\begin{verbatim}
BOV<parameter>=0
\end{verbatim}
Loop over time-varying covariates, initialize BOV tcov
\begin{verbatim}
BOV<covariate>=0
\end{verbatim}
Loop over occasions k=1...N\_occ , one IF block per occasion
\begin{verbatim}
IF (OCC .EQ. k) THEN
\end{verbatim}
[First inner loop, over parameters j=1...bov\_parameters]
\begin{verbatim}
BOV<parameter> = ETA(offset+N_invariant+(k-1)*(bov_parameters+N_timevar)+j)
\end{verbatim}
[Second inner loop (still inside IF BLOCK, but outside first inner loop), over time-varying covariates j=1...N\_variant]
\begin{verbatim}
BOV<covariate> = ETA(offset+N_invariant+(k-1)*(bov_parameters+N_timevar)+bov_parameters+j)
END IF
\end{verbatim}

\subsection{PK or PRED changes at beginning B}
Same as Model 2.

\subsection{PRED or ERROR changes at end}
Same as Model 2.

\section{Initial values off-diagonal OMEGA}

Change prog to allow existing BOV etas? Only require that sorted, i.e. 'neither' then BSV then BOV.


Manuscript says ``In FREM due to nature of parameterization via var-cov matrix the parameter-covariate
relationship
takes an exponential form``. Is that not assuming the parameter, e.g. CL, has exponential BSV eta to begin with?

Definitions:
Base frem model: Two omega blocks: One full omega block for model parameter etas and then separate full block for
covariate etas.

Full frem model: Single full omega block for all etas.

We have difficulties:
1) Obtaining good Initial estimates for OMEGA in full FREM model based on output from base FREM model,
to get successful estimation.

2) Get successful cov step for full FREM model after estimating full FREM model.
Is Jonas formula for this issue, i.e. getting covariances without running covstep, assuming we have
successful cov step for base FREM model, but only estimates for full FREM model?

%variance (\hat Cov(X,Y)) = q(n)/n * (Cov(X,Y)^2 + Var(X) Var(Y))
%Jonas  q(n) = 1 if ML-estiamtes for \hat Cov(X,Y), and converge to 1 when n-> 1 for other estimators.
% N=2\frac{var^2}{SE^2}+1  where var is variance est from NONMEM, SE is SE of variance from NONMEM

Coefficient is computed as
\[
\frac{cov_{par,cov}}{var_{cov}}=\frac{sd_{par}sd_{cov}corr_{par,cov}}{sd_{cov}sd_{cov}}=\frac{sd_{par}}{sd_{cov}}corr_{par,cov}
\]



  cholFullA=chol(FullA);
invGT=  inv(cholFullA'); %compute only leading k block
[q,R]=qr(invGT(:,1:k));
invR=inv(R(1:k,1:k));
result2=invR*invR' 
