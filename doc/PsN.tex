\input{inputs/format_header.tex}
\guidetitle{PsN}{2018-03-02}

\usepackage{tabularx}
\usepackage{hyperref}
\usepackage{dirtree}

\begin{document}
	
	
	\maketitle
	\newcommand{\guidetoolname}{<toolname>}
	\tableofcontents
	\newpage
	
	\section{Introduction}
	%This document aims to be a starting point for the PsN documentation and also to contain topics that are common to the different PsN tools.
	This document aims to contain topics that are common to the different PsN tools.

    \section{The PsN directory structure}
One major task of PsN is to organize the files from NONMEM runs and from runs of the different PsN tools. PsN has two options for directory organization, one default flatter structure and another optional deeper structure. Both will be explained below.
\subsection{The default directory structure}
Let us start in a directory containing one model file and one dataset, like this:
\\
\dirtree{%
    .1 mydir/.
    .2 run1.csv.
    .2 run1.mod.
    }
~\\
The model can be executed using the \verb|execute run1.mod| command. This will create a modelfit rundirectory and the appropriate result files (the lst-file, the generated table files and any other NONMEM result file requested using the \verb|-nm_output| option) will be copied to the model directory. For example:
\\
\dirtree{%
    .1 mydir/.
    .2 modelfit\_dir1/.
    .2 run1.csv.
    .2 run1.lst.
    .2 run1.mod.
    .2 sdtab.
}

\subsection{The -model\_subdir directory structure}
This directory structure is centered around the models and will create a specific subdirectory for each model. It can be activated by using the \verb|-model_subdir| option. To change it to the default structure set this option in the psn.conf. The created subdirectory will contain all result related to tools run on that model and the model directory will be kept untouched. Starting from the same directory as in the previous section and executing the model would then generate the following directory structure:
\\
\dirtree{%
    .1 mydir/.
    .2 run1/.
    .3 modelfit\_dir1/.
    .3 run1.lst.
    .3 sdtab.
    .2 run1.csv.
    .2 run1.mod.
    }
~\\
If next running a bootstrap on the same model the bootstrap results will also be put in the model subdirectory:
\\
\dirtree{%
    .1 mydir/.
    .2 run1/.
    .3 bootstrap\_dir1/.
    .3 modelfit\_dir1/.
    .3 run1.lst.
    .3 sdtab.
    .2 run1.csv.
    .2 run1.mod.
    }

	\section{Metadata}
	All PsN tools generate metadata with information about the specific run. The file 'meta.yaml' is, starting with PsN 4.7.8, created in each run directory with the aim of gathering all the interesting metadata in one place. As a yaml-file the meta.yaml is both easy to read for humans and easy to interpret by computer program. Below is a description of all currently available tags in meta.yaml
	
	\begin{center}
		\begin{tabularx}{\linewidth}{ r X }
			\hline
			Tag & Description \\ \hline
			\verb|command_line| & The command line with the full path to the command \\ \hline
			\verb|common_options| & All common options that were use either explicitly on the command line or from psn.conf \\ \hline
			\verb|copied_files| & A list of all files that were copied back to the calling directory \\ \hline
			\verb|finish_time| & Timestamp for the finish of the PsN run as yyyy-mm-dd hh:mm:ss \\ \hline
			\verb|model_files| & An array of the full\_paths to all model files used as input to run \\ \hline
			\verb|NONMEM_directory| & The full path to were the NONMEM version for this run is stored \\ \hline
			\verb|NONMEM_version| & The version of NONMEM \\ \hline
			\verb|PsN_version| & The version of PsN \\ \hline
			\verb|start_time| & Timestamp for the start of the PsN run as yyyy-mm-dd hh:mm:ss \\ \hline
			\verb|tool_name| & The name of the tool without version extensions \mbox{('-4.7.8')} or developer version extension ('-dev') \\ \hline
			\verb|tool_options| & All tool specific options used for this run. \\ \hline
		\end{tabularx}
	\end{center}
	
	
	
	\section{NONMEM compatibility}
	
	This section describes all known cases where PsN is not entirely compatible with a construct in NONMEM or NM-TRAN.

	\subsection{CHAIN method and parallel\_retries}
	
	There is a PsN tool for running a set of copies of a model file with tweaked initial estimates in parallel. The script is called parallel\_retries and is described in parallel\_retries\_userguide.pdf.
	
	NONMEM 7 can also be used to run a model with tweaked initial estimates. If using the CHAIN method of NONMEM 7 and taking initial estimates from an existing file, that filename must be given to PsN with option -extra\_files, just as a file with a user-written Fortran subroutine. Note: NONMEM does not give an error message if the file with initial estimates is missing. The user must remember to set -extra\_files, otherwise NONMEM will use the initial estimates in the modelfile without giving any warning.
	
	If the file with adjusted initial estimates is generated by the same modelfile which then uses it, no extra PsN options are needed.
	
	Do not use PsN for running a modelfile with CHAIN as the method of a single \$ESTIMATION step, for example when only generating a file with intial estimates. PsN would change the name of the file where newly generated initial estimates are written. See section Raw and additional output, \$ESTIMATION options.
	
	The PsN option tweak\_inits will have no effect if CHAIN is used to take initial estimates from a separate file instead of the model specification itself.
	
	The CHAIN method (reading initial estimates from a rectangular file) will not work with vpc or npc. This is because PsN removes all but the last \$ESTIMATION as part of turning off estimation. It is recommended to generate an msfo file with the desired parameter values, and then send this to npc/vpc via the existing -msfo option. The cdd script will work with CHAIN, since there estimation is turned off in newly created modelfiles with initial estimates read from cdd:s own runs. Option mirror\_plots with execute will also work with CHAIN, since a separate \$PROBLEM with an \$MSFI record is generated for the simulations.
	
	\subsection{Control stream in mixed case}
	In NONMEM 7.2 and higher it is possible to write the control stream in mixed case. PsN does not support this. It is likely that options written in lower case will not be recognized correctly, which can cause errors in scripts which need to modify certain options.

    \subsection{== and /= in \$DATA IGNORE and ACCEPT}
    PsN does not in general support the == and /= in the ACCEPT or IGNORE options of \$. Use .EQ., .EQN., .NE. or .NEN. instead.

	\subsection{INCLUDE and \$INCLUDE}
	The INCLUDE record is not supported. NM-TRAN allows INCLUDE without the dollar-sign and PsN will add this as options or code to the previous record potentially causing strange errors or worse. If \$INCLUDE was used PsN will give a nice error message.
	
	\subsection{New forms of \$SIGMA and \$OMEGA}
	In NONMEM 7.2 it is possible to define \$SIGMA and \$OMEGA in new ways, and indicating this via options STANDARD/VARIANCE COVARIANCE/CORRELATION and CHOLESKY. PsN does accept these options and will pass them on when creating new models, but the output analysis and updating new models with final estimates from a previous run have not been adapted to these new forms, and updating initial estimates in a model with final estimates from a previous run will introduce errors, as PsN will put the final VARIANCE/COVARIANCE estimates
	in \$OMEGA and \$SIGMA without removing the STANDARD/CORRELATION/CHOLESKY options in the control stream. Updating is done by all scripts except execute, sse and parallel\_retries. PsN will print a warning when the new \$OMEGA/\$SIGMA options are encountered.
	
	\subsection{Option ORDER in \$ESTIMATION}
	There is a new option called ORDER in \$EST in NONMEM 7.2. PsN cannot handle any but the default format, and will attempt to remove ORDER if found in \$EST.
	
	\subsection{Raw and additional output, \$ESTIMATION options}
	
	When NONMEM 7 raw and additional output (ext, coi, cov, cor, phi) files exist, results will be read from these files instead of the lst-file. If additional output cannot be found the lst-file is used. NONMEM 7 raw and additional output are handled the same way as lst-files. These files are numbered by retries and, if set in nm\_output, copied back to the calling directory.
	
	PsN only accepts default file names and default formatting of the raw and additional output. If any of the options NOTITLE, NOLABEL or FILE is set in any \$ESTIMATION record, PsN will set the option to the default value in the last \$ESTIMATION. Only the last \$ESTIMATION will be changed. If running sumo on output with non-default formatting, the run is likely to fail. If the delimiter is set to something other than spaces (the default) by using FORMAT or DELIM then PsN output parsing will fail.
	
	In all output, only results (parameter estimates, messages...) from the last \$ESTIMATION will be presented. The only exeception is the MINIMIZATION SUCCESSFUL flag, see that section.
	
	\subsection{Shorthand notation in \$THETA \$OMEGA \$SIGMA}
	PsN does not support VALUES option in \$OMEGA/\$SIGMA. 
	PsN does not support the new shorthand notation in NONMEM 7.3 ( xN notation, SAME(n) notation).
	
	\subsection{Shrinkage}
	
	Shrinkage values are reported as percentages. If option -shrinkage is used, PsN will compute iwres shrinkage and eta shrinkage. 
	Shrinkage is never read from NONMEM output. PsN will compute shrinkage if option -shrinkage is set on the command line.
	
	\subsection{CWRES and iofv}
	
	NONMEM 7 can output iofv, so that option is turned off when running PsN with NONMEM 7. Option -iofv is still available with PsN and NONMEM 6.
	NONMEM 7 can usually output also CWRES, but not in all cases,
	so PsN option -cwres is always enabled.
	
	
	
	
	\section{General technical notes}
	
	\subsection{MINIMIZATION SUCCESSFUL}
	
	The message MINIMIZATION SUCCESSFUL is important for PsN restart behaviour (see details in common\_options.pdf) and sumo output, but it only appears for classical estimation methods. The following logic is used for setting the flag minimization\_successful:
	
	\begin{enumerate}
		\item Only status of last \$EST step is considered, except when last \$EST is IMP with EONLY=1 (see item 7)
		\item BURN-IN/(REDUCED) STATISTICAL PORTION/OPTIMIZATION NOT TESTED - successful
		\item BURN-IN/(REDUCED) STATISTICAL PORTION/OPTIMIZATION COMPLETED - successful
		\item BURN-IN/(REDUCED) STATISTICAL PORTION/OPTIMIZATION NOT COMPLETED PRIOR TO USER INTERRUPT - successful
		\item BURN-IN/(REDUCED) STATISTICAL PORTION/OPTIMIZATION NOT COMPLETED - failed
		\item If any of the two steps in SAEM failed - failed 
		\item If last \$EST is IMP with EONLY=1, the minimization status is determined by the next to last \$EST
	\end{enumerate}
	
	\subsection{Turning off estimation in NONMEM 7}
	
	In some scripts PsN turns off estimation in some extra PsN-generated models. It is done in npc and vpc, in cdd if option -xv is set, and in execute if option -mirror\_plots is set. With NONMEM 5 and NONMEM 6 the estimation is easily skipped by setting MAXEVAL=0. NONMEM 7 however,  can have multiple \$ESTIMATIONs and/or estimation methods for which MAXEVAL do not apply. Settings in one \$ESTIMATION will by default carry over to the next unless a new setting for the same option is set. This makes it much more complicated to automatically edit the modelfile to skip the estimation step and get correct output of PRED, DV etc. 
	
	Of the new estimation methods of NONMEM 7, it is most natural to use IMP or IMPMAP with EONLY=1 for the purposes for which estimation is turned off. If PsN does not need ofv values from the run NITER=0 can be set. This is true for vpc, npc and execute with mirror\_plots. If ofv values are needed as in cdd, NITER=5-10 is sufficient according to NONMEM 7 documentation. PsN will leave NITER unchanged in most cases (see exception below).
	
	When using NONMEM 7, there are two alternatives for the user when running a PsN script that turns off estimation. The first is to make sure 1) that the last \$ESTIMATION has METHOD set to either IMP, IMPMAP or a classical method and 2) that the last \$ESTIMATION is complete, i.e. that all options needed are explicitly set in that record so that none that are needed for that step are carried over from previous \$EST and 3) that PsN is informed of 1 and 2 by setting option -last\_est\_complete. If option -last\_est\_complete is set, PsN will do the following to turn off estimation: 
	\begin{enumerate}
		\item remove all but the last \$ESTIMATION record 
		\item If METHOD in last \$EST is classical: set MAXEVAL=0 
	\end{enumerate}
	or 
	If METHOD is IMP or IMPMAP: set EONLY=1. If running vpc, npc or execute with 
	mirror\_plots also set NITER=0, otherwise do not change NITER.
	If METHOD is any other than classical or IMP/IMPMAP then the last \$EST is not changed and a warning is printed.
	
	The second alternative is to let PsN do everything automatically, by not setting option -last\_est\_complete. Then PsN will collect options (LAPLACIAN, METHOD, ISAMPLE...) from all \$ESTIMATION, removing $\langle$OPTION$\rangle$ if NO$\langle$OPTION$\rangle$ appears, unsetting LIKELIHOOD if PREDICTION appears, changing the value of ISAMPLE and METHOD if/when they appear again, and so on. PsN addresses the fact that options may be abbreviated in many ways. A number of options are skipped, such as FORMAT and FILE and options which only apply to the BAYES method, see list below. After scanning the options, all \$EST are removed and PsN creates a new one based on the collected options. 
	
	\begin{itemize}
		\item If METHOD is classical (i.e. the last \$EST had a classical method), MAXEVAL=0 is set. The rest of the collected options are appended.
		\item If METHOD=IMP or IMPMAP, then EONLY=1 is set. If running vpc, npc or execute with mirror\_plots also set NITER=0, otherwise do not change NITER. The rest of the collected options, including ISAMPLE if it is set, are appended. 
		\item If METHOD is something other than classical/IMP/IMPMAP, then METHOD is changed to IMP, and EONLY=1 is set. For vpc, npc and for mirror\_plots NITER=0 and ISAMPLE=1 are set. For cdd NITER is not changed if it is already set in any of the \$ESTIMATION steps, otherwise NITER=10 is set. ISAMPLE is left to the default value for cdd. The rest of the collected options are appended.
	\end{itemize}
	
	If the option niter\_eonly is set, PsN will set NITER to this value regardless of estimation method and PsN tool (cdd, npc, vpc or execute). This option is independent of last\_est\_complete.
	The following options are skipped when PsN automatically collects options for an \$ESTIMATION record:
	\begin{verbatim}
	NOTITLE, NOLABEL, FORMAT, FILE, MSFO, IACCEPT, PACCEPT, OACCEPT,
	NSIGDIGITS, SIGDIGITS, ISAMPLE_M1, ISAMPLE_M2, ISAMPLE_M3,
	NBURN, PSAMPLE_M1, PSAMPLE_M2, PSAMPLE_M3, OSAMPLE_M1,
	OSAMPLE_M2, OSAMPLE_M3, THETABOUNDTEST, NOTHETABOUNDTEST, NOTBT,
	OMEGABOUNDTEST, NOOMEGABOUNDTEST, NOOBT, SIGMABOUNDTEST,
	NOSIGMABOUNDTEST, NOSBT
	\end{verbatim}
	Options MAXEVALS and EONLY are also skipped, since they will be set anyway in later steps.
	
	The CHAIN method (reading initial estimates from a rectangular file) will not work with vpc or npc, because all but the last \$ESTIMATION are removed as part of turning off estimation. See details, inluding a workaround, in the section CHAIN method. The cdd and execute scripts will work with CHAIN.
	
	
	
\end{document}
