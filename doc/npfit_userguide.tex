\input{inputs/format_header.tex}
\guidetitle{NPFIT user guide}{2016-09-20}

\newcommand{\guidetoolname}{npfit}

\begin{document}

\maketitle


\section{Introduction}
Nonparametric estimation using a range of NPSUPP values.

Examples
\begin{verbatim}
npfit run1.mod -npsupp=50,100,200
\end{verbatim}

\section{Input and options}

\subsection{Required input}
A model file is required, and a list of npsupp-values.
NONMEM requires that the \$ESTIMATION record is present with the conditional method or POSTHOC.
%\subsection{Optional input}

\subsection{Options}
\begin{optionlist}
\optdefault{npsupp}{50,100,200}
Required. A comma-separated list of non-negative integers.
For each value N a new copy of the input model will be run with
\$NONPARAMETRIC UNCONDITIONAL NPSUPP=N
See the NONMEM documentation on \$NONPARAMETRIC for interpretation of NPSUPP.
All values in the list should be equal to or greater than the number
of individuals in the data set.
\nextopt
%\optname{copy\_data}
%\nextopt
%\optname{keep\_tables}
%\nextopt
%\optdefault{rplots}{level}
%\nextopt
\end{optionlist}

\subsection{Some important common PsN options}
There are many options that govern how PsN manages NONMEM runs, and
those options are common to all PsN programs that run NONMEM.
For a complete list of such options see common\_options.pdf, 
or psn\_options -h on the commandline. A selection of
the most important common options relevant for npfit is found here.
\input{inputs/basic_options.tex}

\section{Results}

The file raw\_nonparametric\_modelname.csv, for example raw\_nonparametric\_run1.csv,
contains the parametric and nonparametric ofv, the npsupp value used,
and the nonparametric ETAs.

\section{Internal npfit workflow}

\begin{enumerate}
\item Read the input model into memory.
\item Input checking, i.e. verify that required options are set and valid and that requirements on the input model
are satisfied.
\begin{enumerate}
\item The nonmem version must be 7.4 or later.
\item The model must have \$ESTIMATION in at least one \$PROBLEM. The first \$PROBLEM with \$ESTIMATION will be the
only one being updated in the following procedure.
\item If METHOD is not conditional then \$ESTIMATION must specify POSTHOC.
\end{enumerate}
\item Create (or reopen) a run directory according to the usual PsN conventions.
\item If the run directory already existed, read any models/results that are already present and skip
to the step below where the old process stopped.
\item If there is an lst-file linked to the input model then read the estimation results.
\item If there are no estimation results available for the input model then run the input model and read the estimation results.
\item Find $N_{ind}$, the number of individuals in the data set as reported in the estimation lst-file,
i.e. the number of individuals after any IGNORE/ACCEPT. If $N_{ind}$ is larger than any of the npsupp values
then print a warning.
\item Update initial estimates with the final estimates from the estimation.
\item If the estimation method is classical set MAXEVAL=1 in \$ESTIMATION 
\item For each value i of npsupp, copy the updated model and set \$NONPARAMETRIC UNCONDITIONAL NPSUPP=i
Any pre-existing \$NONPARAMETRIC will be removed.
Write the model copy in the m1 subfolder of the run directory.
\item Run models with NONMEM
\item In the raw\_nonparametric results file, add a column with the npsupp values. 
\item Create, and possibly run, R script.
\end{enumerate}

%\references

\end{document}
